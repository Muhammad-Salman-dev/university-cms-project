{% extends "base.html" %}

{% block content %}
<style>
    .inbox-card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        border: none;
    }
    .message-item {
        transition: 0.2s;
        border-left: 4px solid transparent;
        cursor: pointer;
        text-decoration: none !important;
    }
    .message-item:hover {
        background-color: #f8f9fc !important;
        border-left: 4px solid #3b82f6;
    }
    .message-item.unread {
        background-color: #f4f7ff;
        border-left: 4px solid #3b82f6;
    }
    .message-item.unread .subject-text {
        font-weight: 700;
        color: #1e293b;
    }
    .action-btn {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: #64748b;
        transition: 0.2s;
        text-decoration: none;
    }
    .action-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }
    .btn-delete:hover { color: #ef4444; background: #fee2e2; }


    .inbox-search {
        background: #f1f5f9;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        color: #64748b;
        padding: 10px 20px;
        font-weight: 500;
    }
    .nav-tabs-custom .nav-link.active {
        color: #3b82f6;
        border-bottom: 2px solid #3b82f6;
        background: none;
    }
</style>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">

            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark mb-1">My Inbox</h2>
                    <p class="text-muted small mb-0">Manage your communications and administrative notices.</p>
                </div>
                <div class="mt-2 mt-md-0">
                    <button class="btn btn-primary shadow-sm px-4 py-2" data-bs-toggle="modal" data-bs-target="#composeModal">
                        <i class="fas fa-plus-circle me-2"></i>New Message
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs-custom mb-3 border-bottom">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('faculty.messages') }}">
                        <i class="fas fa-inbox me-2"></i>Inbox
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('faculty.archived_messages') }}">
                        <i class="fas fa-archive me-2"></i>Archive
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('faculty.trash_messages') }}">
                        <i class="fas fa-trash-alt me-2"></i>Trash
                    </a>
                </li>
            </ul>

            <div class="card inbox-card shadow-sm mb-4">
                <div class="card-header bg-white py-3 border-bottom d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-3">
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </div>
                        <button class="btn btn-light btn-sm border me-2" title="Mark All as Read"><i class="fas fa-envelope-open"></i></button>
                        <button class="btn btn-light btn-sm border me-2" title="Archive Selected"><i class="fas fa-archive"></i></button>
                        <button class="btn btn-light btn-sm border text-danger" title="Delete Selected"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="d-none d-md-block">
                        <input type="text" class="form-control form-control-sm inbox-search" placeholder="Search messages...">
                    </div>
                </div>

                <div class="list-group list-group-flush">
                    {% for msg in messages %}
                    <div class="list-group-item message-item border-0 border-bottom px-4 py-3 d-flex align-items-center {{ 'unread' if msg[3] == 0 else '' }}">
                        <div class="me-3">
                            <input type="checkbox" class="form-check-input">
                        </div>

                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fw-bold text-primary small">From: System/Admin</span>
                                <small class="text-muted">{{ msg[2].strftime('%d %b, %H:%M') }}</small>
                            </div>
                            <div class="subject-text text-dark mb-1">{{ msg[0] }}</div>
                            <div class="text-muted small text-truncate" style="max-width: 500px;">{{ msg[1] }}</div>
                        </div>

                        <div class="ms-3 d-flex">
                            <a href="{{ url_for('faculty.archive_message', msg_id=msg[4]) }}" class="action-btn" title="Archive">
                                <i class="fas fa-archive"></i>
                            </a>
                            <a href="{{ url_for('faculty.delete_message', msg_id=msg[4]) }}" class="action-btn btn-delete" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </a>

                            <div class="dropdown">
                                <button class="action-btn border-0 bg-transparent" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                    <li>
                                        <a class="dropdown-item py-2" href="{{ url_for('faculty.mark_as_read', msg_id=msg[4]) }}">
                                            <i class="fas fa-check-circle me-2 text-success"></i>Mark as Read
                                        </a>
                                    </li>
                                    <li><a class="dropdown-item py-2" href="#"><i class="fas fa-reply me-2 text-primary"></i>Reply</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item py-2 text-danger" href="#"><i class="fas fa-ban me-2"></i>Report Spam</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-folder-open fa-4x text-light-emphasis"></i>
                        </div>
                        <h5 class="text-muted">Your inbox is empty</h5>
                        <p class="small text-muted">Messages from admin or students will appear here.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
            <div class="modal-header bg-dark text-white border-0 py-3" style="border-radius: 15px 15px 0 0;">
                <h5 class="modal-title fw-bold"><i class="fas fa-pen-nib me-2"></i>New Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('faculty.send_message') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">Send To</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-user text-primary"></i></span>
                            <select class="form-select border-0 bg-light" name="receiver_type" id="receiverSelect" required onchange="toggleStudentList()">
                                <option value="Admin">System Administrator</option>
                                <option value="Student">Specific Student</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3" id="studentInputDiv" style="display:none;">
                        <label class="form-label fw-bold small text-muted text-uppercase">Student ID</label>
                        <input type="number" name="student_id" class="form-control border-0 bg-light py-2" placeholder="Enter ID (e.g. 101)">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">Subject</label>
                        <input type="text" name="subject" class="form-control border-0 bg-light py-2" placeholder="What is this about?" required>
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-bold small text-muted text-uppercase">Message Body</label>
                        <textarea name="body" class="form-control border-0 bg-light" rows="5" placeholder="Write your message here..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Discard</button>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm">
                        Send Message <i class="fas fa-paper-plane ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleStudentList() {
    var select = document.getElementById('receiverSelect');
    var div = document.getElementById('studentInputDiv');
    div.style.display = (select.value === 'Student') ? 'block' : 'none';
}
</script>
{% endblock %}